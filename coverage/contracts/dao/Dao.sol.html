<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/dao/Dao.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../prettify.css" />
    <link rel="stylesheet" href="../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../index.html">all files</a> / <a href="index.html">contracts/dao/</a> Dao.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">36.07% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>22/61</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">13.89% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>5/36</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">36.84% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>7/19</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">37.1% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>23/62</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">// SPDX-License-Identifier: AGPLv3
pragma solidity ^0.8.4;
&nbsp;
import "../interfaces/dao/IDao.sol";
&nbsp;
// Provides functions to be used internally to track proposals and votes
abstract contract Dao is IDao {
  struct ProposalMetaData {
    address creator;
    string info;
    uint256 submitted;
    mapping(address =&gt; Vote) voters;
    uint256 votesYes;
    uint256 votesNo;
    uint256 expires;
    uint256 queued;
    bool cancelled;
    bool completed;
  }
  mapping(uint256 =&gt; ProposalMetaData) private _proposals;
  uint256 private _nextProposalId;
&nbsp;
<span class="fstat-no" title="function not covered" >  function getProposalCreator(uint256 id) external view override returns (address) {</span>
<span class="cstat-no" title="statement not covered" >    return _proposals[id].creator;</span>
  }
<span class="fstat-no" title="function not covered" >  function getProposalInfo(uint256 id) external view override returns (string memory) {</span>
<span class="cstat-no" title="statement not covered" >    return _proposals[id].info;</span>
  }
<span class="fstat-no" title="function not covered" >  function getVoteStatus(uint256 id, address voter) external view override returns (Vote) {</span>
<span class="cstat-no" title="statement not covered" >    return _proposals[id].voters[voter];</span>
  }
<span class="fstat-no" title="function not covered" >  function getTimeSubmitted(uint256 id) external view override returns (uint256) {</span>
<span class="cstat-no" title="statement not covered" >    return _proposals[id].submitted;</span>
  }
<span class="fstat-no" title="function not covered" >  function getTimeExpires(uint256 id) external view override returns (uint256) {</span>
<span class="cstat-no" title="statement not covered" >    return _proposals[id].expires;</span>
  }
  function getTimeQueued(uint256 id) public view override returns (uint256) {
    return _proposals[id].queued;
  }
<span class="fstat-no" title="function not covered" >  function getCancelled(uint256 id) public view override returns (bool) {</span>
<span class="cstat-no" title="statement not covered" >    return _proposals[id].cancelled;</span>
  }
<span class="fstat-no" title="function not covered" >  function getCompleted(uint256 id) public view override returns (bool) {</span>
<span class="cstat-no" title="statement not covered" >    return _proposals[id].completed;</span>
  }
&nbsp;
  function isProposalActive(uint256 id) public view override returns (bool) {
    return (
      // Proposal must actually exist
      (_proposals[id].submitted != 0) &amp;&amp;
      // Has yet to expire
      (block.timestamp &lt; _proposals[id].expires) &amp;&amp;
      // Wasn't queued
      (_proposals[id].queued == 0) &amp;&amp;
      // Wasn't cancelled
      (!_proposals[id].cancelled) &amp;&amp;
      // Wasn't completed
      (!_proposals[id].completed)
    );
  }
&nbsp;
  modifier activeProposal(uint256 id) {
    <span class="missing-if-branch" title="else path not taken" >E</span>require(isProposalActive(id), "Dao: Proposal isn't active");
    _;
  }
&nbsp;
  // Should only be called by a function which attaches coded meaning to this metadata
  function _createProposal(string calldata info, uint256 expires, uint256 votes) internal returns (uint256 id) {
    id = _nextProposalId;
    _nextProposalId++;
&nbsp;
    ProposalMetaData storage proposal = _proposals[id];
    proposal.creator = msg.sender;
    proposal.info = info;
    proposal.submitted = block.timestamp;
    proposal.expires = expires;
&nbsp;
    emit NewProposal(id, proposal.creator, proposal.info, block.timestamp, expires);
&nbsp;
    _voteYes(id, votes);
  }
&nbsp;
  // This activeProposal should be redundant thanks to the below, yet better safe than sorry
  function _removeVotes(uint256 id, uint256 votes) activeProposal(id) internal {
    <span class="missing-if-branch" title="if path not taken" >I</span>if (_proposals[id].voters[msg.sender] == Vote.Yes) {
<span class="cstat-no" title="statement not covered" >      _proposals[id].votesYes -= votes</span>;
    } else <span class="missing-if-branch" title="if path not taken" >I</span>if (_proposals[id].voters[msg.sender] == Vote.No) {
<span class="cstat-no" title="statement not covered" >      _proposals[id].votesNo -= votes</span>;
    }
    // Doesn't emit an event and this is either followed up by another set or the event emission
    // Also required due to the definition of abstain
    _proposals[id].voters[msg.sender] = Vote.Abstain;
  }
&nbsp;
  function _voteYes(uint256 id, uint256 votes) activeProposal(id) internal {
    // Prevents repeat event emission
    <span class="missing-if-branch" title="else path not taken" >E</span>require(_proposals[id].voters[msg.sender] != Vote.Yes, "Dao: Voter already voted yes");
    _removeVotes(id, votes);
    _proposals[id].voters[msg.sender] = Vote.Yes;
    _proposals[id].votesYes += votes;
    emit YesVote(id, msg.sender, votes);
  }
&nbsp;
<span class="fstat-no" title="function not covered" >  function _voteNo(uint256 id, uint256 votes) activeProposal(id) internal {</span>
<span class="cstat-no" title="statement not covered" >    require(_proposals[id].voters[msg.sender] != Vote.No, "Dao: Voter already voted no")</span>;
<span class="cstat-no" title="statement not covered" >    _removeVotes(id, votes)</span>;
<span class="cstat-no" title="statement not covered" >    _proposals[id].voters[msg.sender] = Vote.No</span>;
<span class="cstat-no" title="statement not covered" >    _proposals[id].votesNo += votes</span>;
<span class="cstat-no" title="statement not covered" >    emit NoVote(id, msg.sender, votes);</span>
  }
&nbsp;
<span class="fstat-no" title="function not covered" >  function _abstain(uint256 id, uint256 votes) activeProposal(id) internal {</span>
<span class="cstat-no" title="statement not covered" >    require(_proposals[id].voters[msg.sender] != Vote.Abstain, "Dao: Voter already abstained")</span>;
<span class="cstat-no" title="statement not covered" >    _removeVotes(id, votes)</span>;
    // removeVotes sets Abstain so no need to do it here; just emit the event
<span class="cstat-no" title="statement not covered" >    emit Abstain(id, msg.sender, votes);</span>
  }
&nbsp;
  // Should only be called by something which acts on the coded meaning of this metadata
<span class="fstat-no" title="function not covered" >  function _queueProposal(uint256 id, uint256 totalVotes) activeProposal(id) internal {</span>
<span class="cstat-no" title="statement not covered" >    ProposalMetaData storage proposal = _proposals[id];</span>
<span class="cstat-no" title="statement not covered" >    require(proposal.votesYes &gt; proposal.votesNo, "Dao: Queueing proposal which didn't pass")</span>;
<span class="cstat-no" title="statement not covered" >    require((proposal.votesYes + proposal.votesNo) &gt; (totalVotes / 10), "Dao: Proposal didn't have 10% participation")</span>;
<span class="cstat-no" title="statement not covered" >    proposal.queued = block.timestamp</span>;
<span class="cstat-no" title="statement not covered" >    emit ProposalQueued(id);</span>
  }
&nbsp;
<span class="fstat-no" title="function not covered" >  function _cancelProposal(uint256 id, address[] calldata voters,</span>
                           uint256[] memory oldVotes, uint256[] memory newVotes) internal {
<span class="cstat-no" title="statement not covered" >    require(voters.length == oldVotes.length, "Dao: Length of voters doesn't match length of old votes")</span>;
<span class="cstat-no" title="statement not covered" >    require(oldVotes.length == newVotes.length, "Dao: Length of voters doesn't match length of new votes")</span>;
&nbsp;
<span class="cstat-no" title="statement not covered" >    uint256 votesYes = _proposals[id].votesYes;</span>
<span class="cstat-no" title="statement not covered" >    for (uint256 i = 0; i &lt; voters.length; i++) {</span>
<span class="cstat-no" title="statement not covered" >      require(_proposals[id].voters[voters[i]] == Vote.Yes, "Dao: Specified voter didn't vote yes")</span>;
      // Should be checked anyways thanks to Solidity's integration of SafeMath
<span class="cstat-no" title="statement not covered" >      require(oldVotes[i] &gt; newVotes[i], "Dao: Old amount of votes was not less than the new amount")</span>;
<span class="cstat-no" title="statement not covered" >      votesYes -= oldVotes[i] - newVotes[i]</span>;
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    require(votesYes &lt;= _proposals[id].votesNo, "Dao: Cancelling a proposal with more yes votes than no votes")</span>;
<span class="cstat-no" title="statement not covered" >    _proposals[id].cancelled = true</span>;
<span class="cstat-no" title="statement not covered" >    emit ProposalCancelled(id);</span>
  }
&nbsp;
<span class="fstat-no" title="function not covered" >  function _completeProposal(uint256 id) internal {</span>
<span class="cstat-no" title="statement not covered" >    ProposalMetaData storage proposal = _proposals[id];</span>
<span class="cstat-no" title="statement not covered" >    require(proposal.queued != 0, "Dao: Proposal wasn't queued")</span>;
<span class="cstat-no" title="statement not covered" >    require((proposal.queued + (12 hours)) &lt; block.timestamp, "Dao: Proposal was queued less than 12 hours ago")</span>;
<span class="cstat-no" title="statement not covered" >    require(!proposal.cancelled, "Dao: Proposal was cancelled")</span>;
<span class="cstat-no" title="statement not covered" >    require(!proposal.completed, "Dao: Proposal was already completed")</span>;
<span class="cstat-no" title="statement not covered" >    proposal.completed = true</span>;
<span class="cstat-no" title="statement not covered" >    emit ProposalCompleted(id);</span>
  }
&nbsp;
  // Enables withdrawing a proposal
  function withdrawProposal(uint256 id) activeProposal(id) external override {
    // Only allow the proposer to withdraw a proposal.
    <span class="missing-if-branch" title="else path not taken" >E</span>require(_proposals[id].creator == msg.sender, "Dao: Only the proposal creator may withdraw it");
    // Could also set completed to true; this is more accurate as completed suggests passed.
    // activeProposal will still catch this.
    _proposals[id].expires = 0;
    emit ProposalWithdrawn(id);
  }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Fri Mar 04 2022 17:14:56 GMT+0100 (Central European Standard Time)
</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
