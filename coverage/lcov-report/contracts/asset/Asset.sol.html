<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/asset/Asset.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../prettify.css" />
    <link rel="stylesheet" href="../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../index.html">all files</a> / <a href="index.html">contracts/asset/</a> Asset.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>0/54</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>0/24</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>0/13</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>0/53</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">// SPDX-License-Identifier: AGPLv3
pragma solidity ^0.8.4;
&nbsp;
import "@openzeppelin/contracts/token/ERC721/IERC721.sol";
&nbsp;
import "../dao/Dao.sol";
import "./AssetERC20.sol";
import "../interfaces/asset/IAsset.sol";
&nbsp;
contract Asset is IAsset, Dao, AssetERC20 {
  address public override oracle;
  uint256 public override votes;
&nbsp;
  struct PlatformInfo {
    address platform;
    uint256 nft;
  }
&nbsp;
  struct DissolutionInfo {
    address purchaser;
    address token;
    uint256 purchaseAmount;
    bool reclaimed;
  }
&nbsp;
  // Height at which a proposal was proposed, and the height of which balances are used
  mapping(uint256 =&gt; uint256) public override proposalVoteHeight;
  // Various extra info for proposals
  mapping(uint256 =&gt; PlatformInfo) private _platformChange;
  mapping(uint256 =&gt; address) private _oracleChange;
  mapping(uint256 =&gt; DissolutionInfo) private _dissolution;
&nbsp;
<span class="fstat-no" title="function not covered" >  constructor(</span>
    address platform,
    address _oracle,
    uint256 nft,
    uint256 shares,
    string memory symbol
  ) AssetERC20(platform, nft, shares, symbol) {
<span class="cstat-no" title="statement not covered" >    votes = shares</span>;
<span class="cstat-no" title="statement not covered" >    oracle = _oracle</span>;
  }
&nbsp;
<span class="fstat-no" title="function not covered" >  modifier beforeProposal() {</span>
<span class="cstat-no" title="statement not covered" >    require((balanceOf(msg.sender) != 0) ||</span>
            (msg.sender == address(platform)) || (msg.sender == address(oracle)),
            "Asset: Proposer is not authorized to create a proposal");
    _;
  }
&nbsp;
<span class="fstat-no" title="function not covered" >  function proposePaper(string calldata info) beforeProposal() external override returns (uint256) {</span>
<span class="cstat-no" title="statement not covered" >    uint256 id = _createProposal(info, block.timestamp + 30 days, balanceOf(msg.sender));</span>
<span class="cstat-no" title="statement not covered" >    proposalVoteHeight[id] = block.number</span>;
<span class="cstat-no" title="statement not covered" >    return id;</span>
  }
&nbsp;
<span class="fstat-no" title="function not covered" >  function proposePlatformChange(string calldata info, address platform,</span>
                                 uint256 newNFT) beforeProposal() external override returns (uint256 id) {
<span class="cstat-no" title="statement not covered" >    id = _createProposal(info, block.timestamp + 30 days, balanceOf(msg.sender))</span>;
<span class="cstat-no" title="statement not covered" >    proposalVoteHeight[id] = block.number</span>;
<span class="cstat-no" title="statement not covered" >    _platformChange[id] = PlatformInfo(platform, newNFT)</span>;
<span class="cstat-no" title="statement not covered" >    emit ProposedPlatformChange(id, platform);</span>
  }
&nbsp;
<span class="fstat-no" title="function not covered" >  function proposeOracleChange(string calldata info,</span>
                               address newOracle) beforeProposal() external override returns (uint256 id) {
<span class="cstat-no" title="statement not covered" >    id = _createProposal(info, block.timestamp + 30 days, balanceOf(msg.sender))</span>;
<span class="cstat-no" title="statement not covered" >    proposalVoteHeight[id] = block.number</span>;
<span class="cstat-no" title="statement not covered" >    _oracleChange[id] = newOracle</span>;
<span class="cstat-no" title="statement not covered" >    emit ProposedOracleChange(id, newOracle);</span>
  }
&nbsp;
<span class="fstat-no" title="function not covered" >  function proposeDissolution(string calldata info, address purchaser, address token,</span>
                              uint256 purchaseAmount) beforeProposal() external override returns (uint256 id) {
<span class="cstat-no" title="statement not covered" >    require(purchaseAmount != 0, "Asset: Dissolution amount is 0")</span>;
<span class="cstat-no" title="statement not covered" >    id = _createProposal(info, block.timestamp + 30 days, balanceOf(msg.sender))</span>;
<span class="cstat-no" title="statement not covered" >    proposalVoteHeight[id] = block.number</span>;
<span class="cstat-no" title="statement not covered" >    _dissolution[id] = DissolutionInfo(purchaser, token, purchaseAmount, false)</span>;
<span class="cstat-no" title="statement not covered" >    IERC20(token).transferFrom(msg.sender, address(this), purchaseAmount)</span>;
<span class="cstat-no" title="statement not covered" >    emit ProposedDissolution(id, purchaser, token, purchaseAmount);</span>
  }
&nbsp;
<span class="fstat-no" title="function not covered" >  function voteYes(uint256 id) external override {</span>
<span class="cstat-no" title="statement not covered" >    _voteYes(id, balanceOfAtHeight(msg.sender, proposalVoteHeight[id]))</span>;
  }
<span class="fstat-no" title="function not covered" >  function voteNo(uint256 id) external override {</span>
<span class="cstat-no" title="statement not covered" >    _voteNo(id, balanceOfAtHeight(msg.sender, proposalVoteHeight[id]))</span>;
  }
<span class="fstat-no" title="function not covered" >  function abstain(uint256 id) external override {</span>
<span class="cstat-no" title="statement not covered" >    _abstain(id, balanceOfAtHeight(msg.sender, proposalVoteHeight[id]))</span>;
  }
&nbsp;
<span class="fstat-no" title="function not covered" >  function passProposal(uint256 id) external override {</span>
    // If this is a dissolution, require they didn't reclaim the funds
    // There's a temporary time window before this function is called where the proposal has expired, yet isn't queued
    // Reclaiming funds is allowed during this time as that looks identical to a failed proposal
<span class="cstat-no" title="statement not covered" >    if (_dissolution[id].purchaseAmount != 0) {</span>
<span class="cstat-no" title="statement not covered" >      require(!_dissolution[id].reclaimed, "Asset: Dissolution had its funds reclaimed")</span>;
    }
<span class="cstat-no" title="statement not covered" >    _queueProposal(id, totalSupply())</span>;
  }
&nbsp;
  // Renegers refers to anyone who has reneged from their stake and therefore should no longer be considered as voters
<span class="fstat-no" title="function not covered" >  function cancelProposal(uint256 id, address[] calldata renegers) external override {</span>
<span class="cstat-no" title="statement not covered" >    uint256[] memory oldVotes = new uint[](renegers.length);</span>
<span class="cstat-no" title="statement not covered" >    uint256[] memory newVotes = new uint[](renegers.length);</span>
<span class="cstat-no" title="statement not covered" >    for (uint256 i = 0; i &lt; renegers.length; i++) {</span>
<span class="cstat-no" title="statement not covered" >      oldVotes[i] = balanceOfAtHeight(renegers[i], proposalVoteHeight[id])</span>;
<span class="cstat-no" title="statement not covered" >      newVotes[i] = balanceOf(renegers[i])</span>;
    }
<span class="cstat-no" title="statement not covered" >    _cancelProposal(id, renegers, oldVotes, newVotes)</span>;
  }
&nbsp;
<span class="fstat-no" title="function not covered" >  function enactProposal(uint256 id) external override {</span>
<span class="cstat-no" title="statement not covered" >    _completeProposal(id)</span>;
&nbsp;
<span class="cstat-no" title="statement not covered" >    if (_platformChange[id].platform != address(0)) {</span>
<span class="cstat-no" title="statement not covered" >      platform = _platformChange[id].platform</span>;
<span class="cstat-no" title="statement not covered" >      nft = _platformChange[id].nft</span>;
<span class="cstat-no" title="statement not covered" >      IERC721(platform).safeTransferFrom(platform, address(this), nft)</span>;
<span class="cstat-no" title="statement not covered" >      emit PlatformChanged(id, platform);</span>
    } else <span class="cstat-no" title="statement not covered" >if (_oracleChange[id] != address(0)) {</span>
<span class="cstat-no" title="statement not covered" >      emit OracleChanged(id, oracle, _oracleChange[id]);</span>
<span class="cstat-no" title="statement not covered" >      oracle = _oracleChange[id]</span>;
    } else <span class="cstat-no" title="statement not covered" >if (_dissolution[id].purchaseAmount != 0) {</span>
<span class="cstat-no" title="statement not covered" >      _distribute(IERC20(_dissolution[id].token), _dissolution[id].purchaseAmount)</span>;
<span class="cstat-no" title="statement not covered" >      IERC721(platform).safeTransferFrom(address(this), _dissolution[id].purchaser, nft)</span>;
<span class="cstat-no" title="statement not covered" >      dissolved = true</span>;
<span class="cstat-no" title="statement not covered" >      _pause()</span>;
<span class="cstat-no" title="statement not covered" >      emit Dissolved(id, _dissolution[id].purchaser, _dissolution[id].purchaseAmount);</span>
    }
  }
&nbsp;
<span class="fstat-no" title="function not covered" >  function reclaimDissolutionFunds(uint256 id) external override {</span>
    // Require the proposal have ended
<span class="cstat-no" title="statement not covered" >    require(!isProposalActive(id), "Asset: Dissolution proposal is active")</span>;
    // If the proposal was queued, require it to have been cancelled
<span class="cstat-no" title="statement not covered" >    if (getTimeQueued(id) != 0) {</span>
<span class="cstat-no" title="statement not covered" >      require(getCancelled(id), "Asset: Dissolution was queued yet not cancelled")</span>;
    }
&nbsp;
    // Require this is actually a dissolution
<span class="cstat-no" title="statement not covered" >    require(_dissolution[id].purchaseAmount != 0, "Asset: Proposal isn't a dissolution")</span>;
&nbsp;
    // Require the dissolution wasn't already reclaimed
<span class="cstat-no" title="statement not covered" >    require(!_dissolution[id].reclaimed, "Asset: Dissolution was already reclaimed")</span>;
<span class="cstat-no" title="statement not covered" >    _dissolution[id].reclaimed = true</span>;
&nbsp;
    // Transfer the tokens
<span class="cstat-no" title="statement not covered" >    IERC20(_dissolution[id].token).transfer(_dissolution[id].purchaser, _dissolution[id].purchaseAmount)</span>;
  }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Fri Mar 04 2022 17:14:56 GMT+0100 (Central European Standard Time)
</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
